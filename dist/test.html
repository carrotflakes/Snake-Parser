<!DOCTYPE html>
<html>
<head>
	<title>Snake parser</title>
	<meta charset="UTF-8">

<style>

	textarea {
		font-family: Consolas, 'Courier New', Courier, Monaco, monospace;
		font-size: small;
	}

	h4 {
		margin: 4px 0px;
	}

	#syntaxMessage, #resultMessage {
		background-color: #FE8;
		font-size: small;
		width: 550px
	}

	p {
		margin: 2px 0px;
	}

	.group {
		display:inline-block;
		vertical-align: top;
	}

</style>

</head>
<body>

	<div>
	Examples :
	<select id="examples">
	<option value="0">calculator</option>
	<option value="1">snake grammar</option>
	</select>
	</div>

	<div class="group">
	<h4>Grammar :</h4>
	<div id="grammar" style="width: 550px; height: 500px;"></div>

	<p id="syntaxMessage"></p>
	</div>

	<div class="group">
	<h4>Input text :</h4>
	<div id="input_text" style="width: 550px; height: 200px;"></div>

	<p id="resultMessage"></p>

	<h4>Output :</h4>
	<textarea id="result" style="width: 550px; height: 200px"></textarea>
	<br>
	<button onclick="toJS();">Generate</button>
	</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="snakeParser.js"></script>
<script>

var parser = null, code = null;
var syntaxMessageElm = document.getElementById("syntaxMessage"),
resultMessageElm = document.getElementById("resultMessage");
var updateParserTime = new Date().getTime(),
updateModifierTime = new Date().getTime(),
updateInputTextTime = new Date().getTime();
var grammarEditor = ace.edit("grammar");
var inputTextEditor = ace.edit("input_text");

grammarEditor.$blockScrolling = Infinity;
inputTextEditor.$blockScrolling = Infinity;

grammarEditor.getSession().on('change', function() {
	updateParserTime = new Date().getTime() + 1000;
});
inputTextEditor.getSession().on('change', function() {
	updateInputTextTime = new Date().getTime() + 1000;
});

grammarEditor.setDisplayIndentGuides(false);
inputTextEditor.setDisplayIndentGuides(false);

window.setInterval(function() {
	var now = new Date().getTime();
	if (updateParserTime < now) {
		updateParserTime = Infinity;
		updateInputTextTime = Infinity;

		buildParser();
		parse();
	} else if (updateInputTextTime < now) {
		updateInputTextTime = Infinity;

		parse();
	}
}, 250);


function buildParser() {
	var grammar = grammarEditor.getValue();
	code = null;
	parser = null;

	try {
		var t = new Date().getTime();
    code = SnakeParser.buildParser(grammar);
		parser = eval(code);
		t = new Date().getTime() - t;

		syntaxMessageElm.innerHTML = ("Parser built successfully.\n" + t + "ms").replace(/\n/g, "<br>");
  } catch (e) {
		syntaxMessageElm.innerHTML = e.message.replace(/\n/g, "<br>");
		parser = null;
  }

	resultMessageElm.innerHTML = "";
};


function parse() {
	if (parser === null)
		return;

	var resultElem = document.getElementById("result");

	resultElem.value = "";

	var inputText = inputTextEditor.getValue();

	try {
		var t = new Date().getTime();
		var result = parser(inputText);
		t = new Date().getTime() - t;

		resultMessageElm.innerHTML = ("Input parsed successfully.\n" + t + "ms").replace(/\n/g, "<br>");
		resultElem.value = JSON.stringify(result, null, "  ");
	} catch (e) {
		resultMessageElm.innerHTML = e.message.replace(/\n/g, "<br>");
		resultElem.value = "";
	}
};

function toJS() {
	if (code === null)
		return;

	var resultElem = document.getElementById("result");

	resultElem.value = code;
};

function example(idx) {
	grammarEditor.setValue(examples[idx].grammar);
	inputTextEditor.setValue(examples[idx].inputText);
	grammarEditor.clearSelection();
	inputTextEditor.clearSelection();

	updateParserTime = new Date().getTime();
};

var examples = [
{
	grammar: "{\n  function add(o) {\n    return o.left + o.right;\n  }\n  function subtract(o) {\n    return o.left - o.right;\n  }\n  function multiple(o) {\n    return o.left * o.right;\n  }\n  function divide(o) {\n    return o.left / o.right;\n  }\n  function modulo(o) {\n    return o.left % o.right;\n  }\n  function integer(o) {\n    return +o;\n  }\n}\n\nstart\n  = ws additive ws\n\nadditive\n  = {left:additive ws \"+\" ws right:multiplicative} -> add\n  | {left:additive ws \"-\" ws right:multiplicative} -> subtract\n  | multiplicative\n\nmultiplicative\n  = {left:multiplicative ws \"*\" ws right:primary} -> multiple\n  | {left:multiplicative ws \"/\" ws right:primary} -> divide\n  | {left:multiplicative ws \"%\" ws right:primary} -> modulo\n  | primary\n\nprimary\n  = integer\n  | \"(\" ws additive ws \")\"\n\ninteger \"integer\"\n  = `(?'-' +[0-9]) -> integer\n\nws \"whitespace\"\n  = *[ \\t\\r\\n]",
	inputText: '1+2*(3+4)'
}, {
	grammar: "{\n    function rules(rules) {\n        var lines = [];\n        lines.push(\"{\");\n        for (var i in rules) {\n            lines.push(rule(rules[i]) + \",\");\n        }\n        lines.push(\"}\");\n        return lines.join(\"\\n\");\n    }\n    function rule(rule) {\n        var lines = [];\n        lines.push(\"\\t\" + JSON.stringify(rule.ident) + \": {\");\n        lines.push(\"\\t\\tident: \" + JSON.stringify(rule.ident) + \",\");\n        if (rule.parameters)\n            lines.push(\"\\t\\tparameters: \" + JSON.stringify(rule.parameters) + \",\");\n        if (rule.name)\n            lines.push(\"\\t\\tname: \" + JSON.stringify(rule.name) + \",\");\n        lines.push(\"\\t\\tbody: \" + rule.body + \",\");\n        lines.push(\"\\t}\");\n        return lines.join(\"\\n\");\n    }\n    function arrayToObject($) {\n        var res = {};\n        for (var i = 0, il = $.length; i < il; ++i)\n            res[$[i].ident] = $[i];\n        return res;\n    }\n    function ensureMin($) {\n        return $ === undefined ? 0 : $;\n    }\n    function ensureMax($) {\n        return $ === undefined ? Infinity : $;\n    }\n    function characterClassChar($) {\n        var str = $,\n        len = str.length;\n        if (len === 1) {\n            return str.charCodeAt();\n        } else if (len === 6) {\n            return parseInt(str.substring(2), 16);\n        } else if (str === \"\\\\n\") {\n            return 10;\n        } else if (str === \"\\\\t\") {\n            return 9;\n        } else if (str === \"\\\\r\") {\n            return 13;\n        }\n        return str.charCodeAt(1);\n    }\n    function nuturalNumber($) {\n        return +$;\n    }\n    function expr($) {\n        switch ($.op) {\n        case \"nop\":\n        case \"ac\":\n            return $.op + \"()\";\n        case \"oc\":\n        case \"seq\":\n            return $.op + \"([\" + $.a + \"])\";\n        case \"pr\":\n            return $.op + \"(\" + JSON.stringify($.a) + \",\" + $.b + \")\";\n        case \"mod\":\n        case \"grd\":\n            return $.op + \"(\" + $.a + \",\" + JSON.stringify($.b) + \",\" + JSON.stringify($.c) + \")\";\n        case \"str\":\n            return $.op + \"(\" + JSON.stringify($.a) + \")\";\n        case \"cc\":\n            return $.op + \"(\" + JSON.stringify($.a) + \",\" + JSON.stringify($.b) + \")\";\n        case \"ltr\":\n            return $.op + \"(\" + JSON.stringify($.a) + \")\";\n        case \"arr\":\n        case \"obj\":\n        case \"tkn\":\n        case \"pla\":\n        case \"nla\":\n        case \"wst\":\n            return $.op + \"(\" + $.a + \")\";\n        case \"rep\":\n            return $.op + \"(\" + $.a + \",\" + ($.b === \"min\" ? $.a : $.b) + \",\" + $.c + \")\";\n        case \"pi\":\n            return $.op + \"(\" + $.a + \")\";\n        case \"rul\":\n			if ($.b)\n                return $.op + \"(\" + JSON.stringify($.a) + \",[\" + $.b + \"])\";\n			else\n                return $.op + \"(\" + JSON.stringify($.a) + \")\";\n        }\n    }\n}\n\n\nstart\n    =   {\n            __\n            initializer:(CodeBlock __ | \\\"\")\n            rules:@*Rule -> rules\n        }\n\nRule\n    =   {\n            ident:Identifier __\n            ?(parameters:RuleParameters __)\n            ?(name:StringLiteral __)\n            '=' __\n            body:ChoiceExpression __\n        }\n\nRuleParameters\n    = @(\n            \"<\" __\n            ?(\n                Identifier __\n                *(\",\" __ Identifier __)\n            )\n            \">\"\n        )\n\nChoiceExpression\n    = {op:=oc a:@(SequenceExpression __ +('|' __ SequenceExpression))} -> expr __\n    | SequenceExpression __\n\nSequenceExpression\n    = {op:=seq a:@(LabelExpression +(__ LabelExpression))} -> expr __\n    | LabelExpression __\n\nLabelExpression\n    = {\n				op:=pr\n        a:IdentifierOrStringLiteral __\n        ':=' __\n        b:{ op:=ltr a:IdentifierOrStringLiteral } -> expr\n      } -> expr\n    | {op:=pr a:IdentifierOrStringLiteral __ ':'  __ b:ModifyExpression} -> expr\n    | ModifyExpression\n\nModifyExpression\n    =   {\n            (\n                a:ModifyExpression __\n                (\n                    '->' __\n                    op:=mod\n                    (b:Identifier c:\\null | b:\\null c:CodeBlock)\n                |\n                    '-?' __\n                    op:=grd\n                    (b:Identifier c:\\null | b:\\null c:CodeBlock)\n                |\n                    '-|'\n                    op:=wst\n                )\n            )\n        } -> expr\n    | OtherExpression\n\nOtherExpression\n    = '(' __ (ChoiceExpression | {op:=nop} -> expr) __ ')'\n    |   { op:=str a:StringLiteral\n        | op:=cc  '[' b:('^' \\true | \\false) a:CharacterClass ']'\n        | op:=ltr '\\\\' __ a:(StringLiteral | NumericLiteral | BooleanLiteral | NullLiteral)\n        | op:=arr '@' __ a:OtherExpression\n        | op:=obj '{' __ a:ChoiceExpression __ '}'\n        | op:=tkn '`' __ a:OtherExpression\n        | op:=pla '&' __ a:OtherExpression\n        | op:=nla '!' __ a:OtherExpression\n        | op:=rep '?' __ c:OtherExpression a:\\0 b:\\1\n        | op:=rep '*' __ c:OtherExpression a:\\0 b:\\0 -> {return Infinity}\n        | op:=rep a:NaturalNumber __ '*' __ c:OtherExpression b:\\\"min\"\n        | op:=rep a:?NaturalNumber->ensureMin ',' b:?NaturalNumber->ensureMax __ '*' __ c:OtherExpression\n        | op:=rep '+' __ c:OtherExpression a:\\1 b:\\0 -> {return Infinity}\n        | op:=ac  '.'\n        | op:=pi  '$' a:Identifier\n        | op:=rul !Rule a:Identifier ?(__ b:RuleArguments)\n        } -> expr\n\nRuleArguments\n    = @(\n            \"<\" __\n            ?(\n                ChoiceExpression __\n                *(\",\" __ ChoiceExpression __)\n            )\n            \">\"\n        )\n\n__ \"white space\"\n    = *([ \\t\\r\\n] | Comment)\n\nComment\n    = '//' *[^\\n] ('\\n' | !.)\n    | '/*' *([^*] | '*' [^/]) '*/'\n\nLineTerminator\n    = [\\n\\r\\u2028\\u2029]\n\nIdentifier \"identifier\"\n    = `([a-zA-Z_] *[a-zA-Z0-9_])\n\nIdentifierOrStringLiteral\n    = StringLiteral | Identifier\n\nStringLiteral \"string literal\"\n    = `StringLiteralRaw -> eval\n\nStringLiteralRaw\n    =   (\n            '\\''\n            *(!LineTerminator [^'\\\\] | '\\\\x' 2*HexDigit | '\\\\u' 4*HexDigit | '\\\\' [^ux])\n            '\\''\n        )\n    |   (\n            '\\\"'\n            *(!LineTerminator [^\"\\\\] | '\\\\x' 2*HexDigit | '\\\\u' 4*HexDigit | '\\\\' [^ux])\n            '\\\"'\n        )\n\nCharacterClass\n    = @*{\n            type:\\\"range\"\n            start:CharacterClassChar '-' end:CharacterClassChar\n        |   type:\\\"single\"\n            char:CharacterClassChar\n        }\n\nCharacterClassChar\n    = `([^\\]\\\\]\n    | '\\\\x' 2*HexDigit\n    | '\\\\u' 4*HexDigit\n    | '\\\\' [^ux]) -> characterClassChar\n\nCodeBlock \"code block\"\n    = \"{\" `Code \"}\"\n\nCode\n    = *([^{}] | \"{\" Code \"}\")\n\nNaturalNumber \"natural number\"\n    = `([1-9] *[0-9] | \"0\") -> nuturalNumber\n\n\nNullLiteral\n    = \"null\" \\null\n\nBooleanLiteral\n    = \"true\"    \\true\n    | \"false\" \\false\n\nNumericLiteral \"numeric literal\"\n    = `(?\"-\" (HexIntegerLiteral | DecimalLiteral)) -> eval\n\nDecimalLiteral\n    = DecimalIntegerLiteral \".\" *DecimalDigit ?ExponentPart\n    | \".\" +DecimalDigit ?ExponentPart\n    | DecimalIntegerLiteral ?ExponentPart\n\nDecimalIntegerLiteral\n    = \"0\"\n    | NonZeroDigit *DecimalDigit\n\nDecimalDigit\n    = [0-9]\n\nNonZeroDigit\n    = [1-9]\n\nExponentPart\n    = ExponentIndicator SignedInteger\n\nExponentIndicator\n    = [eE]\n\nSignedInteger\n    = ?[+-] +DecimalDigit\n\nHexIntegerLiteral\n    = (\"0x\" | \"0X\") +HexDigit\n\nHexDigit\n    = [0-9a-fA-F]",
	inputText: 'start = "hello world"'
},
];

document.getElementById("examples").onchange = function(e) {
	example(+document.getElementById("examples").value);
};

example(0);

</script>
</html>
